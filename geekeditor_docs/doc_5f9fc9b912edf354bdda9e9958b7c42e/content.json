{"content":[{"key":"header","data":{"content":"<strong>一、相机</strong>","level":1},"common":{"quote":false}},{"key":"paragraph","data":{"content":"Android 的相机硬件抽象层 (HAL) 可将 <a href=\"http://developer.android.com/reference/android/hardware/package-summary.html?hl=zh-cn\">Camera 2</a> 中较高层级的相机框架 API 连接到底层的相机驱动程序和硬件。相机子系统包括相机管道组件的实现，而相机 HAL 可提供用于实现您的这些组件版本的接口。<strong>注意</strong>：如果您要在搭载 Android 8.0 及更高版本的设备上实现相机 HAL，则必须使用 HIDL 接口。如需了解旧版组件，请参阅<a href=\"https://source.android.com/docs/core/camera?hl=zh-cn#architecture-legacy\">旧版 HAL 组件</a>。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>二、架构（Architecture）</strong>","level":1},"common":{"quote":false}},{"key":"paragraph","data":{"content":"下列图表和列表说明了HAL组件"},"common":{"quote":false}},{"key":"image","data":{"image":{"url":"https://rqh3nmk4yk3.feishu.cn/space/api/box/stream/download/asynccode/?code=YjdmMmE0MWQ2YjJhYzU4MTQ3MzQ5MmY0ZTFkNGE3NWJfU3RsQ2FwMG5CYkdpZFkzWHVBUDlZYmJTZ1pKRDIxS25fVG9rZW46SUxSSmJBMjlJb3NNOG94dFRRZGM3MWxabndkXzE3MDY5MTgxMzI6MTcwNjkyMTczMl9WNA"},"caption":"","withCaption":true},"common":{"quote":false}},{"key":"paragraph","data":{"content":"<strong> &nbsp; &nbsp; 图1.相机架构 </strong>"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>2.1 应用框架（app Framework）</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"应用代码位于应用框架级别，它使用 <a href=\"https://developer.android.com/reference/android/hardware/camera2/package-summary?hl=zh-cn\">Camera 2</a> API 与相机硬件进行互动。在内部，此代码会调用相应的 <a href=\"https://developer.android.com/reference/android/os/Binder.html?hl=zh-cn\">Binder</a> 接口，以访问与相机互动的原生代码。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>2.2 AIDL</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"与 <code>CameraService</code> 关联的 binder 接口可在 <a href=\"https://android.googlesource.com/platform/frameworks/av/+/master/camera/aidl/android/hardware/ICameraService.aidl\">frameworks/av/camera/aidl/android/hardware</a> 中找到。生成的代码会调用较低级别的原生代码以获取对实体相机的访问权限，并返回用于在框架级别创建 <code><a href=\"https://developer.android.com/reference/android/hardware/camera2/CameraDevice?hl=zh-cn\">CameraDevice</a></code> 并最终创建 <code><a href=\"https://developer.android.com/reference/android/hardware/camera2/CameraCaptureSession.html?hl=zh-cn\">CameraCaptureSession</a></code> 对象的数据。<span>暂时无法在飞书文档外展示此内容</span>"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>2.3 原生框架（native framework）</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"此框架位于 <code>frameworks/av/</code> 中，并提供相当于 <code><a href=\"https://developer.android.com/reference/android/hardware/camera2/CameraDevice?hl=zh-cn\">CameraDevice</a></code> 和 <code><a href=\"https://developer.android.com/reference/android/hardware/camera2/CameraCaptureSession?hl=zh-cn\">CameraCaptureSession</a></code> 类的原生类。另请参阅 <a href=\"https://developer.android.com/ndk/reference/group/camera?hl=zh-cn\">NDK camera2 参考</a>。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>2.4 binder </strong><strong>IPC</strong><strong>接口</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"IPC binder 接口用于实现跨越进程边界的通信。调用相机服务的若干个相机 binder 类位于<code>frameworks/av/camera/camera/aidl/android/hardware</code> 目录中。<code><a href=\"https://android.googlesource.com/platform/frameworks/av/+/master/camera/aidl/android/hardware/ICameraService.aidl\">ICameraService</a></code> 是相机服务的接口；<code><a href=\"https://android.googlesource.com/platform/frameworks/av/+/master/camera/aidl/android/hardware/camera2/ICameraDeviceUser.aidl\">ICameraDeviceUser</a></code> 是已打开的特定相机设备的接口；<code><a href=\"https://android.googlesource.com/platform/frameworks/av/+/master/camera/aidl/android/hardware/ICameraServiceListener.aidl\">ICameraServiceListener</a></code> 和 <code><a href=\"https://android.googlesource.com/platform/frameworks/av/+/master/camera/aidl/android/hardware/camera2/ICameraDeviceCallbacks.aidl\">ICameraDeviceCallbacks</a></code> 分别是对应用框架的 <code>CameraService</code> 和 <code>CameraDevice</code> 回调。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>2.5 相机服务</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"位于 <code>frameworks/av/services/camera/libcameraservice/CameraService.cpp</code> 下的相机服务是与 HAL 进行互动的实际代码。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>2.6 </strong><strong>HAL</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"硬件抽象层定义了由相机服务调用、且您必须实现以确保相机硬件正常运行的标准接口。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>2.7、实现</strong><strong>HAL</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"HAL 位于相机驱动程序和更高级别的 Android 框架之间，它定义您必须实现的接口，以便应用可以正确地操作相机硬件。相机 HAL 的 <a href=\"https://source.android.com/docs/core/architecture/hidl?hl=zh-cn\">HIDL</a> 接口在 <a href=\"https://android.googlesource.com/platform/hardware/interfaces/+/master/camera/\">hardware/interfaces/camera</a> 中定义。典型的绑定式 HAL 必须实现以下 HIDL 接口："},"common":{"quote":false}},{"key":"list","data":{"style":"unordered","items":[{"content":"<code><a href=\"https://android.googlesource.com/platform/hardware/interfaces/+/refs/heads/master/camera/provider/2.4/ICameraProvider.hal\">ICameraProvider</a></code>：用于枚举单个设备并管理其状态。","style":"unordered","closed":false,"items":[]},{"content":"<code><a href=\"https://android.googlesource.com/platform/hardware/interfaces/+/refs/heads/master/camera/device/3.2/ICameraDevice.hal\">ICameraDevice</a></code>：相机设备接口。","style":"unordered","closed":false,"items":[]},{"content":"<code><a href=\"https://android.googlesource.com/platform/hardware/interfaces/+/refs/heads/master/camera/device/3.2/ICameraDeviceSession.hal\">ICameraDeviceSession</a></code>：活跃的相机设备会话接口。","style":"unordered","closed":false,"items":[]}]},"common":{"quote":false}},{"key":"paragraph","data":{"content":"参考 HIDL 实现适用于 <code><a href=\"https://android.googlesource.com/platform/hardware/interfaces/+/master/camera/provider/2.4/default/CameraProvider_2_4.cpp\">CameraProvider.cpp</a></code>、<code><a href=\"https://android.googlesource.com/platform/hardware/interfaces/+/master/camera/device/3.2/default/CameraDevice.cpp\">CameraDevice.cpp</a></code> 和 <code><a href=\"https://android.googlesource.com/platform/hardware/interfaces/+/master/camera/device/3.2/default/CameraDeviceSession.cpp\">CameraDeviceSession.cpp</a></code>。该实现封装了仍在使用<a href=\"https://android.googlesource.com/platform/hardware/libhardware/+/master/include/hardware/camera3.h\">旧版 API</a> 的旧 HAL。从 Android 8.0 开始，相机 HAL 实现必须使用 HIDL API；不支持使用旧版接口。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>四、旧版</strong><strong>HAL</strong><strong>组件</strong>","level":1},"common":{"quote":false}},{"key":"paragraph","data":{"content":"此部分介绍了旧版 HAL 组件的架构以及如何实现 HAL。搭载 Android 8.0 或更高版本的设备上的相机 HAL 实现必须改用 HIDL API（如上所述）。"},"common":{"quote":false}},{"key":"header","data":{"content":"4.1 架构（旧版）","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"下列图表和列表说明了旧版相机 HAL 组件。"},"common":{"quote":false}},{"key":"image","data":{"image":{"url":"https://rqh3nmk4yk3.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjVjNzdkZTQ1ZTZmYzBmZGUxZWU1OThhNzgyM2RkZDdfQnFQR3E4cTBXZ1NQSHVtQXpnZTVLT1RZQlVEQ0Q1M1RfVG9rZW46VDQ4S2IxRFNZb0EzWjR4NFIxRGNPdVB4bkFnXzE3MDY5MTgxMzI6MTcwNjkyMTczMl9WNA"},"caption":"图 2.&nbsp;旧版相机架构","withCaption":true},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>4.2 应用框架</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"应用代码位于应用框架级别，它使用 <code><a href=\"http://developer.android.com/reference/android/hardware/Camera.html?hl=zh-cn\">android.hardware.Camera</a></code> API 与相机硬件进行互动。在内部，此代码会调用相应的 JNI 粘合类，以访问与相机互动的原生代码。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>4.3 JNI</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"与 <code><a href=\"http://developer.android.com/reference/android/hardware/Camera.html?hl=zh-cn\">android.hardware.Camera</a></code> 相关联的 JNI 代码位于 <code>frameworks/base/core/jni/android_hardware_Camera.cpp</code> 中。此代码会调用较低级别的原生代码以获取对实体相机的访问权限，并返回用于在框架级别创建 <code><a href=\"http://developer.android.com/reference/android/hardware/Camera.html?hl=zh-cn\">android.hardware.Camera</a></code> 对象的数据。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>4.4 原生框架</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"在 <code>frameworks/av/camera/Camera.cpp</code> 中定义的原生框架可提供相当于 <code><a href=\"http://developer.android.com/reference/android/hardware/Camera.html?hl=zh-cn\">android.hardware.Camera</a></code> 类的原生类。此类会调用 IPC binder 代理，以获取对相机服务的访问权限。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>4.5 binder </strong><strong>IPC</strong><strong>代理</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"IPC binder 代理用于促进跨越进程边界的通信。调用相机服务的 3 个相机 binder 类位于 <code>frameworks/av/camera</code> 目录中。<code>ICameraService</code> 是相机服务的接口，<code>ICamera</code> 是已打开的特定相机设备的接口，<code>ICameraClient</code> 是返回到应用框架的设备接口。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>4.6 相机服务</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"位于 <code>frameworks/av/services/camera/libcameraservice/CameraService.cpp</code> 下的相机服务是与 HAL 进行互动的实际代码。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>4.7 </strong><strong>HAL</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"硬件抽象层定义了由相机服务调用、且您必须实现以确保相机硬件正常运行的标准接口。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>4.8 内核驱动程序</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"相机的驱动程序可与实际相机硬件以及您的 HAL 实现进行互动。相机和驱动程序必须支持 YV12 和 NV21 图像格式，以便在显示和视频录制时支持预览相机图像。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>4.9 实现</strong><strong>HAL</strong><strong>(旧版)</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"HAL 位于相机驱动程序和更高级别的 Android 框架之间，它定义您必须实现的接口，以便应用可以正确地操作相机硬件。HAL 接口在 <code>hardware/libhardware/include/hardware/camera.h</code> 和 <code>hardware/libhardware/include/hardware/camera_common.h</code> 头文件中定义。<code>camera_common.h</code> 定义 <code>camera_module</code>，这是一个标准结构，可用于获取有关相机的一般信息，例如相机 ID 和所有相机通用的属性（例如，相机是前置还是后置）。<code>camera.h</code> 包含与 <code><a href=\"http://developer.android.com/reference/android/hardware/Camera.html?hl=zh-cn\">android.hardware.Camera</a></code> 对应的代码。此头文件会声明一个 <code>camera_device</code> 结构，该结构又反过来包含一个带函数指针（可实现 HAL 接口）的 <code>camera_device_ops</code> 结构。如需查看有关开发者可以设置的相机参数的文档，请参阅 <code>frameworks/av/include/camera/CameraParameters.h</code>。通过 HAL 中的 <code>int (*set_parameters)(struct camera_device *, const char *parms)</code> 来设置这些参数以及指向的函数。如需查看 HAL 实现的示例，请参阅 <code>hardware/ti/omap4xxx/camera</code> 中的 Galaxy Nexus HAL 实现。"},"common":{"quote":false}},{"key":"header","data":{"content":"<strong>4.10 配置</strong><strong>共享库</strong>","level":2},"common":{"quote":false}},{"key":"paragraph","data":{"content":"设置 Android 构建系统，以将 HAL 实现正确打包到共享库中，并通过创建<code>Android.mk</code>文件将其复制到相应位置："},"common":{"quote":false}},{"key":"list","data":{"style":"ordered","items":[{"content":"创建一个<code>device/&lt;company_name&gt;/&lt;device_name&gt;/camera</code>目录以包含您的库的源文件。","style":"unordered","closed":false,"items":[]},{"content":"创建一个<code>Android.mk</code>文件以构建共享库。确保 makefile 包含以下行：","style":"unordered","closed":false,"items":[]}]},"common":{"quote":false}},{"key":"code","data":{"lang":"","lines":["LOCAL_MODULE := camera.&lt;device_name&gt;","LOCAL_MODULE_RELATIVE_PATH := hw"]},"common":{"quote":false}},{"key":"paragraph","data":{"content":"您的库必须命名为 <code>camera.&lt;device_name&gt;</code>（自动附加 <code>.so</code>），以便 Android 可以正确加载库。如需查看示例，请参阅 <code>hardware/ti/omap4xxx/Android.mk</code> 中的 Galaxy Nexus 相机的 makefile。"},"common":{"quote":false}},{"key":"list","data":{"style":"ordered","items":[{"content":"使用设备的 makefile 复制 <code>frameworks/native/data/etc</code> 目录中的必要功能 XML 文件，以指定设备具有相机功能。例如，如需指定设备具有相机闪光灯并可自动对焦，请在设备的 <code>&lt;device&gt;/&lt;company_name&gt;/&lt;device_name&gt;/device.mk</code> makefile 中添加以下行","style":"unordered","closed":false,"items":[]}]},"common":{"quote":false}},{"key":"code","data":{"lang":"","lines":["PRODUCT_COPY_FILES := \\ ...","​","PRODUCT_COPY_FILES += \\","<span class=\"be-code__section\">frameworks/native/data/etc/android.hardware.camera.flash-autofocus.xml:system/etc/permissions/android.hardware.camera.flash-autofocus.xml \\</span>"]},"common":{"quote":false}},{"key":"list","data":{"style":"ordered","items":[{"content":"在 <code>device/&lt;company_name&gt;/&lt;device_name&gt;/media_profiles.xml</code> 和 <code>device/&lt;company_name&gt;/&lt;device_name&gt;/media_codecs.xml</code> XML 文件中声明相机的媒体编解码器、格式和分辨率功能。如需了解详情，请参阅<a href=\"https://source.android.com/docs/core/media?hl=zh-cn#expose\">将编解码器展示给框架</a>。","style":"unordered","closed":false,"items":[]},{"content":"在设备的 <code>device/&lt;company_name&gt;/&lt;device_name&gt;/device.mk</code> makefile 中添加以下行，以将 <code>media_profiles.xml</code> 和 <code>media_codecs.xml</code> 文件复制到相应位置：","style":"unordered","closed":false,"items":[]}]},"common":{"quote":false}},{"key":"code","data":{"lang":"","lines":["<span class=\"be-code__comment\"># media config xml file</span>","PRODUCT_COPY_FILES += \\"," &nbsp; &nbsp;&lt;device&gt;/&lt;company&gt;/&lt;device&gt;/media_profiles.xml:system/etc/media_profiles.xml","​","<span class=\"be-code__comment\"># media codec config xml file</span>","PRODUCT_COPY_FILES += \\"," &nbsp; &nbsp;&lt;device&gt;/&lt;company&gt;/&lt;device&gt;/media_codecs.xml:system/etc/media_codecs.xml"]},"common":{"quote":false}},{"key":"list","data":{"style":"ordered","items":[{"content":"如需将相机应用包含在设备的系统映像中，请在设备的 <code>device/&lt;company&gt;/&lt;device&gt;/device.mk</code> makefile 的 <code>PRODUCT_PACKAGES</code> 变量中指定相机应用：","style":"unordered","closed":false,"items":[]}]},"common":{"quote":false}},{"key":"code","data":{"lang":"","lines":["PRODUCT_PACKAGES := \\","Gallery2 \\","..."]},"common":{"quote":false}},{"key":"paragraph","data":{"content":""},"common":{}}],"typeset":"github","layout":"web","basic":{"title":"","cover":"","summary":""}}